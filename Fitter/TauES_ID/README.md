# TauFW Fitter

## Installation

See [the README.md in the parent directory](../../../#taufw).

## Creating inputs:

See [the README.md in the TauES directory ](../TauES)

## Running the fit:

python makecombinedFitTES_SF.py -y UL2018 -o 1 -c TauES_ID/config/FitSetupTES_mutau_noSF.yml
-> for more information on the different parts, please look into the python script

The fit is done using [Combine tool](https://cms-analysis.github.io/HiggsAnalysis-CombinedLimit/).

### Config file : 

* important information about samples, processes, systematics, variations etc. given in config file in yaml format
* examples of yaml files are given in TauES_ID/config/defaultFitSetupTES_mutau.yml 
  -- explanations are given as comments within the file
* this file is currently being used in TauES/createInputsTES.py, TauES_ID/harvestDatacards_TES_idSF_MCStat.py, makecombinedfitTES_SF.py, plotParabola_POI.py and ../Plotter/plot.py
  -- it can (and will) be used in further scipts / routines in the future
* each config file defines the setup for one specific channel
  -- combinations of channels can be done at datacard level, e.g. to include a mumu-CR
* you can easily make changes on cuts, observables, regions, etc. through the config file
* important information to define in the config file to use makecombinedfitTES_SF.py :
  - 'regions': one datacard file is created for each region. A region contains a definition and a title.
  - 'plottingOrder': used by plotParabola_POI.py to make the summary plot of the POI measurements.
  - 'tesRegions': tes are scanned in this regions. Title are defined. 
  - 'tid_SFRegions': tid SF are scanned in this regions.  Title are defined.
  - 'observables ': observable to fit : usally m_vis.
    - 'fitRegions': for each observable, fit regions are defined.
    - 'scanRegions': for each observable, the region to scan the poi. 

### Preparing the datacards:

The datacards are generated by /TauES_ID/harvestDatacards_TES_idSF_MCStat_region.py. 

The input to Combine tool is a datacards file (ztt files). The datacards are generated for each region defined in the config file and contain the parameter of interest to scan (tes or/and tid_SF), the nuisance parameter (systematic), the processes... The systematic have shape effect (shape) or rate effect (lnN). The tid_SF is introduced as a rateParameter (rateParam). For the option 3, 4, 5 of the fit, the datacards of each region are combined in one datacard file (combinedatacard.txt or .root file). The systematic with the same name (ex tid_pt1 of DM0 and tid_pt1 of DM10) will be assumed 100% correlated. The autoMCstat function is used to have bin-by-bin uncertainties for the sum of all backgrounds.

### Fit option
The option 4,5,6 use combined datacards and are useful to fit on several regions. (ex: tes_DM and tid_SF_pt ...)

1.  Option 1 : This is the default option.For each 'scanRegions' of each 'observable' defined in the config file, a scan of the parameter of interest (POI) tes is done. The scan is done in the range specify in the config file. The tid_SF is a nuisance parameter.
2.  Option 2 :  For each 'scanRegions' of each 'observable' defined in the config file, a scan of the parameter of interest (POI) tif_SF is done. The tes is a nuisance parameter.
3.  Option 3 : For each 'scanRegions' of each 'observable' a 2D scan of the POI tes and tid_SF is done. Note that they need to be in the same region (ex: tes_DM0 and tid_SF_DM0).
4.  Option 4 : For each 'scanRegions' of each 'observable' defined in the config file, a scan of the parameter of interest (POI) tif_SF is done. The tes and the tid_SF of other regions are nuisance parameters.
5.  Option 5 : For each 'scanRegions' of each 'observable' defined in the config file, a scan of the parameter of interest (POI) tes is done. The tid_SF and the tes of other regions are nuisance parameters.
6.  Option 5 : For each 'tesRegions' and 'tidRegions' defined in the config file, a 2D scan of the parameters of interest (POI) tes and tid_SF is done. The tid_SF and the tes of other regions are nuisance parameters.
